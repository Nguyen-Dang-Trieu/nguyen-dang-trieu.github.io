---
title: Linux IO
date: 2025-1-21
categories: [Linux]
tags: [Device Driver, IO]
author: Trieu
image:
  path: assets/articles/2025/Linux_IO/2025-1-27-header.png
  alt: Linux IO
---

## Má»Ÿ Ä‘áº§u
Äá»‘i vá»›i má»™t á»©ng dá»¥ng (hay má»™t tiáº¿n trÃ¬nh trong há»‡ Ä‘iá»u hÃ nh), khÃ´ng gian bá»™ nhá»› Ä‘Æ°á»£c chia thÃ nh 2 pháº§n:
- KhÃ´ng gian háº¡t nhÃ¢n **(Kernel-space)**: Ä‘Æ°á»£c chia sáº½ vá»›i cÃ¡c tiáº¿n trÃ¬nh khÃ¡c.
- KhÃ´ng gian ngÆ°á»i dÃ¹ng **(User-space)**: riÃªng Ä‘á»‘i vá»›i má»—i tiáº¿n trÃ¬nh.

Cáº£ hai Ä‘á»u náº±m trong khÃ´ng gian Ä‘á»‹a chá»‰ áº£o **(Virtual Memory)**. Tiáº¿n trÃ¬nh ngÆ°á»i dÃ¹ng khÃ´ng thá»ƒ trá»±c tiáº¿p truy cáº­p vÃ o khÃ´ng gian kernel. Thay vÃ o Ä‘Ã³, nÃ³ chá»‰ cÃ³ quyá»n truy cáº­p vÃ o 
khÃ´ng gian ngÆ°á»i dÃ¹ng **(User-space)** vÃ  cáº§n sao chÃ©p dá»¯ liá»‡u vÃ o khÃ´ng gian kernel thÃ´ng qua cÆ¡ cháº¿ do há»‡ Ä‘iá»u hÃ nh cung cáº¥p (nhÆ° cÃ¡c lá»i gá»i há»‡ thá»‘ng - **System call**). Sau Ä‘Ã³, kernel 
sáº½ xá»­ lÃ½ dá»¯ liá»‡u theo yÃªu cáº§u cá»§a tiáº¿n trÃ¬nh.

## IO lÃ  gÃ¬

Trong há»‡ thá»‘ng mÃ¡y tÃ­nh, **I/O (Input/Output)** cÃ³ nghÄ©a lÃ  Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra. TÃ¹y theo Ä‘á»‘i tÆ°á»£ng hoáº¡t Ä‘á»™ng, I/O cÃ³ thá»ƒ Ä‘Æ°á»£c phÃ¢n loáº¡i thÃ nh nhiá»u mÃ´ hÃ¬nh khÃ¡c nhau nhÆ°: I/O Ä‘Ä©a, I/O máº¡ng, 
I/O Ã¡nh xáº¡ bá»™ nhá»›, I/O trá»±c tiáº¿p, I/O cÆ¡ sá»Ÿ dá»¯ liá»‡u, v.v. Báº¥t ká»³ há»‡ thá»‘ng nÃ o cÃ³ cÃ¡c kiá»ƒu Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra Ä‘á»u cÃ³ thá»ƒ Ä‘Æ°á»£c coi lÃ  má»™t **há»‡ thá»‘ng I/O**. CÃ³ thá»ƒ nÃ³i, I/O chÃ­nh lÃ  kÃªnh trao 
Ä‘á»•i dá»¯ liá»‡u vÃ  cáº§u ná»‘i tÆ°Æ¡ng tÃ¡c giá»¯a con ngÆ°á»i ğŸ™â€â™‚ï¸ vÃ  mÃ¡y tÃ­nh ğŸ’» trong toÃ n bá»™ há»‡ Ä‘iá»u hÃ nh. ÄÃ¢y lÃ  má»™t khÃ¡i niá»‡m phá»• quÃ¡t, khÃ´ng phá»¥ thuá»™c vÃ o ngÃ´n ngá»¯ láº­p trÃ¬nh hay cÃ´ng nghá»‡ phÃ¡t 
triá»ƒn cá»¥ thá»ƒ.

Trong cÃ¡c há»‡ thá»‘ng ngÃ y nay, I/O Ä‘Ã³ng vai trÃ² quan trá»ng hÃ ng Ä‘áº§u. CÃ¡c há»‡ thá»‘ng hiá»‡n Ä‘áº¡i thÆ°á»ng pháº£i xá»­ lÃ½ khá»‘i lÆ°á»£ng lá»›n tá»‡p tin vÃ  cÃ¡c hoáº¡t Ä‘á»™ng cÆ¡ sá»Ÿ dá»¯ liá»‡u phá»©c táº¡p. Nhá»¯ng hoáº¡t 
Ä‘á»™ng nÃ y phá»¥ thuá»™c nhiá»u vÃ o hiá»‡u suáº¥t I/O cá»§a há»‡ thá»‘ng, vÃ  Ä‘Ã¢y thÆ°á»ng lÃ  nguyÃªn nhÃ¢n chÃ­nh gÃ¢y ra táº¯c ngháº½n hiá»‡u nÄƒng. Náº¿u hiá»‡u suáº¥t I/O khÃ´ng Ä‘á»§ cao, toÃ n bá»™ há»‡ thá»‘ng sáº½ bá»‹ cháº­m láº¡i, 
báº¥t ká»ƒ CPU hay bá»™ nhá»› cÃ³ máº¡nh Ä‘áº¿n Ä‘Ã¢u.

Äá»ƒ cáº£i thiá»‡n hiá»‡u suáº¥t I/O, cÃ¡c giáº£i phÃ¡p tá»‘i Æ°u hÃ³a Ä‘Ã£ Ä‘Æ°á»£c Ã¡p dá»¥ng, cháº³ng háº¡n nhÆ°:
- Bá»• sung bá»™ nhá»› Ä‘á»‡m trong kiáº¿n trÃºc há»‡ thá»‘ng nháº±m giáº£m Ä‘á»™ trá»… vÃ  tÄƒng tá»‘c Ä‘á»™ pháº£n há»“i.
- Thay tháº¿ á»• cá»©ng cÆ¡ há»c (HDD) truyá»n thá»‘ng báº±ng á»• Ä‘Ä©a thá»ƒ ráº¯n (SSD) Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ truy cáº­p dá»¯ liá»‡u á»Ÿ cáº¥p Ä‘á»™ pháº§n cá»©ng.
  
CÃ³ thá»ƒ nÃ³i, pháº§n lá»›n khÃ´ng gian tá»‘i Æ°u hÃ³a há»‡ thá»‘ng náº±m á»Ÿ viá»‡c cáº£i thiá»‡n liÃªn káº¿t I/O, bá»Ÿi vÃ¬ Ä‘Ã¢y thÆ°á»ng lÃ  **Ä‘iá»ƒm ngháº½n chÃ­nh**. Trong khi Ä‘Ã³, hiá»‡u suáº¥t cá»§a CPU vÃ  bá»™ nhá»› hiáº¿m khi lÃ  nguyÃªn nhÃ¢n gÃ¢y ra táº¯c ngháº½n trong há»‡ thá»‘ng hiá»‡n Ä‘áº¡i.

**Váº­y dá»¯ liá»‡u vÃ o á»Ÿ Ä‘Ã¢u vÃ  ra á»Ÿ Ä‘Ã¢u?**
- Input: Dá»¯ liá»‡u Ä‘Æ°á»£c nháº­p vÃ o bá»™ nhá»› (RAM).
- Output: Dá»¯ liá»‡u Ä‘Æ°á»£c xuáº¥t ra cÃ¡c thiáº¿t bá»‹ I/O (nhÆ° á»• Ä‘Ä©a, máº¡ng, hoáº·c cÃ¡c thiáº¿t bá»‹ cáº§n tÆ°Æ¡ng tÃ¡c vá»›i bá»™ nhá»›).

![CPU -> Ram -> Disk](/assets/articles/2025/Linux_IO/2025-1-27-IO.png){: .normal }
_Flow IO_

Má»™t vÃ¹ng cá»§a bá»™ nhá»› chÃ­nh (thÆ°á»ng lÃ  DRAM) Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ táº¡m thá»i ná»™i dung cá»§a há»‡ thá»‘ng tá»‡p (file system), bao gá»“m cáº£ dá»¯ liá»‡u vÃ  siÃªu dá»¯ liá»‡u.

## Giao tiáº¿p IO (Input/Output)
Giao tiáº¿p IO lÃ  quÃ¡ trÃ¬nh truyá»n dá»¯ liá»‡u trá»±c tiáº¿p giá»¯a cÃ¡c thiáº¿t bá»‹ ngoáº¡i vi (thiáº¿t bá»‹ IO) vÃ  bá»™ nhá»› thÃ´ng qua cÃ¡c giao diá»‡n IO. Há»‡ Ä‘iá»u hÃ nh cung cáº¥p cÃ¡c giao diá»‡n IO (Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i sáºµn) mÃ  chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng trá»±c tiáº¿p trong quÃ¡ trÃ¬nh láº­p trÃ¬nh.

![API Interface IO](/assets/articles/2025/Linux_IO/2025-1-28-InterfaceIO.png){: .normal }

Äá»‘i vá»›i ngÆ°á»i dÃ¹ng, khi muá»‘n giao tiáº¿p vá»›i cÃ¡c thiáº¿t bá»‹ ngoáº¡i vi, chá»‰ cáº§n sá»­ dá»¥ng cÃ¡c lá»‡nh gá»i há»‡ thá»‘ng (System Call) Ä‘Æ°á»£c há»‡ Ä‘iá»u hÃ nh há»— trá»£, mÃ  khÃ´ng cáº§n pháº£i quan tÃ¢m Ä‘áº¿n cÃ¡ch thá»©c hoáº¡t Ä‘á»™ng bÃªn trong.

## Bá»™ nhá»› Ä‘á»‡m á»Ÿ kháº¯p má»i nÆ¡i
![Buffer IO](/assets/articles/2025/Linux_IO/2025-1-28-buffer.png){: .normal }

Khi chÆ°Æ¡ng trÃ¬nh thá»±c hiá»‡n cÃ¡c thao tÃ¡c trÃªn tá»‡p, dá»¯ liá»‡u ngÆ°á»i dÃ¹ng (User Data) Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n Ä‘Ä©a (Disk) theo cÃ¡c cáº¥p báº­c tá»« trÃªn xuá»‘ng dÆ°á»›i, nhÆ° trong hÃ¬nh minh há»a. Há»‡ thá»‘ng Ä‘Æ°á»£c chia thÃ nh cháº¿ Ä‘á»™ ngÆ°á»i dÃ¹ng **(User Mode)** vÃ  cháº¿ Ä‘á»™ nhÃ¢n **(Kernel Mode)**, Ä‘Æ°á»£c phÃ¢n cÃ¡ch bá»Ÿi Ä‘Æ°á»ng liá»n mÃ u Ä‘en á»Ÿ giá»¯a.

### 1.Thao tÃ¡c tá»‡p á»Ÿ User Mode
- ThÆ° viá»‡n stdio (C Library): CÃ¡c hÃ m thao tÃ¡c tá»‡p nhÆ° `fread`, `fwrite` Ä‘Æ°á»£c cung cáº¥p bá»Ÿi thÆ° viá»‡n C (stdio). Nhá»¯ng hÃ m nÃ y Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i Ä‘á»ƒ há»— trá»£ Ä‘a ná»n táº£ng vÃ  hoáº¡t Ä‘á»™ng trong User Mode.
- Bá»™ Ä‘á»‡m stdio (Stdio Buffer):
  - CÃ¡c hÃ m `stdio` sá»­ dá»¥ng bá»™ Ä‘á»‡m riÃªng (stdio buffer) trong cháº¿ Ä‘á»™ ngÆ°á»i dÃ¹ng Ä‘á»ƒ giáº£m táº§n suáº¥t gá»i lá»‡nh gá»i há»‡ thá»‘ng (System Call), vá»‘n ráº¥t tá»‘n kÃ©m.
VÃ­ dá»¥: Khi báº¡n ghi hoáº·c Ä‘á»c tá»‡p vá»›i kÃ­ch thÆ°á»›c nhá», thÆ° viá»‡n stdio sáº½ gom dá»¯ liá»‡u vÃ o bá»™ Ä‘á»‡m trÆ°á»›c, sau Ä‘Ã³ má»›i gá»i má»™t láº§n ghi/Ä‘á»c lá»›n hÆ¡n Ä‘á»ƒ cáº£i thiá»‡n hiá»‡u suáº¥t.
  - NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ tÃ¹y chá»‰nh bá»™ Ä‘á»‡m nÃ y báº±ng cÃ¡c hÃ m nhÆ° `setbuf()` hoáº·c xÃ³a bá»™ Ä‘á»‡m báº±ng cÃ¡ch gá»i `fflush()`.

### 2.Thao tÃ¡c tá»‡p á»Ÿ Kernel Mode
- Kernel Buffer Cache: Khi Kernel Mode, giá»¯a cÃ¡c lá»‡nh gá»i há»‡ thá»‘ng (read, write) vÃ  thao tÃ¡c thá»±c táº¿ trÃªn Ä‘Ä©a, cÃ³ má»™t lá»›p bá»™ Ä‘á»‡m gá»i lÃ  **Kernel Buffer Cache**.
- Trong Linux, lá»›p nÃ y gá»“m hai khÃ¡i niá»‡m:
  - **Page Cache**: LÆ°u trá»¯ ná»™i dung cá»§a cÃ¡c tá»‡p, liÃªn quan cháº·t cháº½ Ä‘áº¿n há»‡ thá»‘ng tá»‡p (file system).
  - **Buffer Cache**: LÆ°u trá»¯ dá»¯ liá»‡u cá»§a cÃ¡c khá»‘i thiáº¿t bá»‹ lÆ°u trá»¯ (nhÆ° sector cá»§a Ä‘Ä©a), khÃ´ng phá»¥ thuá»™c vÃ o há»‡ thá»‘ng tá»‡p.
Hai khÃ¡i niá»‡m nÃ y Ä‘Ã´i khi dá»… bá»‹ nháº§m láº«n, nhÆ°ng Page Cache thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng cho tá»‡p, cÃ²n Buffer Cache dÃ¹ng cho dá»¯ liá»‡u thiáº¿t bá»‹ lÆ°u trá»¯ cáº¥p tháº¥p.

## NgÄƒn xáº¿p IO cá»§a Linux
Máº·c dÃ¹ chÃºng ta cÃ³ thá»ƒ Ä‘Æ¡n giáº£n Ä‘á»c/ghi dá»¯ liá»‡u tá»« cÃ¡c thiáº¿t bá»‹ ngoáº¡i vi thÃ´ng qua cÃ¡c lá»‡nh gá»i há»‡ thá»‘ng (System Call), nhÆ°ng lá»£i Ã­ch thá»±c sá»± Ä‘áº¿n tá»« kiáº¿n trÃºc ngÄƒn xáº¿p IO hoÃ n chá»‰nh cá»§a Linux.

![Linux IO Stack](/assets/articles/2025/Linux_IO/2025-1-28-StackLinuxIO_v6.9.png){: .normal }

Trong Linux, ngÄƒn xáº¿p IO Ä‘Æ°á»£c chia thÃ nh ba cáº¥p Ä‘á»™ chÃ­nh:

**Lá»›p há»‡ thá»‘ng tá»‡p (File System Layer)**
- Táº¡i lá»›p nÃ y, cÃ¡c lá»‡nh gá»i há»‡ thá»‘ng nhÆ° write(2) sáº½ sao chÃ©p dá»¯ liá»‡u tá»« khÃ´ng gian ngÆ°á»i dÃ¹ng (User Space) sang Bá»™ nhá»› Ä‘á»‡m cá»§a há»‡ thá»‘ng tá»‡p (File System Buffer) trong khÃ´ng gian kernel.
- Bá»™ Ä‘á»‡m nÃ y giÃºp tÄƒng hiá»‡u suáº¥t báº±ng cÃ¡ch gom cÃ¡c thao tÃ¡c nhá» láº» thÃ nh má»™t khá»‘i lá»›n hÆ¡n trÆ°á»›c khi Ä‘á»“ng bá»™ vá»›i lá»›p bÃªn dÆ°á»›i.
  
**Lá»›p khá»‘i (Block Layer)**
- Lá»›p khá»‘i (Block Layer) quáº£n lÃ½ hÃ ng Ä‘á»£i I/O (IO Queue) cá»§a cÃ¡c thiáº¿t bá»‹ lÆ°u trá»¯ khá»‘i (Block Storage Devices). Nhiá»‡m vá»¥ chÃ­nh cá»§a lá»›p nÃ y lÃ  há»£p nháº¥t vÃ  sáº¯p xáº¿p cÃ¡c yÃªu cáº§u I/O theo thá»© tá»± tá»‘i Æ°u, nháº±m cáº£i thiá»‡n hiá»‡u suáº¥t truy cáº­p cÃ¡c thiáº¿t bá»‹ lÆ°u trá»¯
  
**Lá»›p thiáº¿t bá»‹ (Device Layer)**
- ÄÃ¢y lÃ  lá»›p trá»±c tiáº¿p tÆ°Æ¡ng tÃ¡c vá»›i pháº§n cá»©ng, sá»­ dá»¥ng **DMA (Direct Memory Access)** Ä‘á»ƒ truyá»n dá»¯ liá»‡u giá»¯a bá»™ nhá»› vÃ  thiáº¿t bá»‹ lÆ°u trá»¯ cá»¥ thá»ƒ mÃ  khÃ´ng cáº§n CPU can thiá»‡p nhiá»u.

### CÃ¡c cÆ¡ cháº¿ Ä‘Æ°á»£c káº¿t ná»‘i vá»›i ngÄƒn xáº¿p IO cá»§a Linux nhÆ° tháº¿ nÃ o?
HÃ¬nh trÃªn hÆ¡i phá»©c táº¡p. HÃ£y váº½ má»™t sÆ¡ Ä‘á»“ Ä‘Æ¡n giáº£n vÃ  thÃªm vá»‹ trÃ­ cá»§a cÃ¡c cÆ¡ cháº¿ nÃ y

![Simple Linux IO Stack](/assets/articles/2025/Linux_IO/2025-1-28-Simple_LinuxIO.png){: .normal }

### QuÃ¡ trÃ¬nh Ä‘á»c dá»¯ liá»‡u trong Buffered I/O truyá»n thá»‘ng vá»›i hÃ m `read(2)?
NgÄƒn xáº¿p IO trong Linux liÃªn káº¿t cháº·t cháº½ vá»›i cÃ¡c cÆ¡ cháº¿ hoáº¡t Ä‘á»™ng tá»« viá»‡c má»Ÿ tá»‡p (open) Ä‘áº¿n Ä‘á»c tá»‡p (read). DÆ°á»›i Ä‘Ã¢y lÃ  quy trÃ¬nh Ä‘Æ¡n giáº£n hÃ³a cá»§a Buffered IO trong trÆ°á»ng há»£p Ä‘á»c má»™t tá»‡p khÃ´ng tá»“n táº¡i trong Cache:

**Má»Ÿ tá»‡p open(2)**

Khi thá»±c hiá»‡n lá»‡nh open(2) Ä‘á»ƒ má»Ÿ tá»‡p, kernel sáº½ thiáº¿t láº­p cÃ¡c cáº¥u trÃºc dá»¯ liá»‡u liÃªn quan, nhÆ° mÃ´ táº£ thÃ´ng tin vá» tá»‡p trong há»‡ thá»‘ng.

**Äá»c tá»‡p read(2)**

Lá»‡nh read(2) Ä‘Æ°á»£c gá»i Ä‘á»ƒ yÃªu cáº§u Ä‘á»c dá»¯ liá»‡u tá»« tá»‡p. QuÃ¡ trÃ¬nh nÃ y diá»…n ra qua cÃ¡c bÆ°á»›c sau:
- Lá»›p há»‡ thá»‘ng tá»‡p (File System layer): Kernel kiá»ƒm tra Page Cache cá»§a há»‡ thá»‘ng tá»‡p. Náº¿u dá»¯ liá»‡u cáº§n Ä‘á»c khÃ´ng tá»“n táº¡i trong Page Cache, kernel sáº½ Ã¡nh xáº¡ vá»‹ trÃ­ trÃªn Ä‘Ä©a cáº§n Ä‘á»c.
- Lá»›p khá»‘i (Block Layer):
  - YÃªu cáº§u Ä‘á»c dá»¯ liá»‡u Ä‘Æ°á»£c gá»­i Ä‘áº¿n hÃ ng Ä‘á»£i IO cá»§a thiáº¿t bá»‹ khá»‘i (IO Queue).
  - Táº¡i Ä‘Ã¢y, há»‡ thá»‘ng quáº£n lÃ½ vÃ  sáº¯p xáº¿p cÃ¡c yÃªu cáº§u IO Ä‘á»ƒ tá»‘i Æ°u hÃ³a hiá»‡u suáº¥t truy cáº­p Ä‘Ä©a.
- Lá»›p trÃ¬nh Ä‘iá»u khiá»ƒn thiáº¿t bá»‹ (Device Driver layer):
  - Sau khi yÃªu cáº§u Ä‘Æ°á»£c xá»­ lÃ½ táº¡i hÃ ng Ä‘á»£i, kernel chuyá»ƒn nÃ³ Ä‘áº¿n trÃ¬nh Ä‘iá»u khiá»ƒn thiáº¿t bá»‹ (Device Driver).
  - TrÃ¬nh Ä‘iá»u khiá»ƒn sá»­ dá»¥ng DMA Ä‘á»ƒ Ä‘á»c cÃ¡c cung Ä‘Ä©a tÆ°Æ¡ng á»©ng vÃ o Bá»™ nhá»› Ä‘á»‡m cá»§a kernel (Kernel Buffer).

**Tráº£ dá»¯ liá»‡u vá» khÃ´ng gian ngÆ°á»i dÃ¹ng**

Khi dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»c tá»« Ä‘Ä©a vÃ o bá»™ Ä‘á»‡m kernel: Kernel sáº½ sao chÃ©p dá»¯ liá»‡u tá»« Bá»™ nhá»› Ä‘á»‡m kernel (Kernel Buffer) sang Bá»™ Ä‘á»‡m cá»§a ngÆ°á»i dÃ¹ng (User Buffer) Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh trong lá»‡nh read(2).

## Blocking/non-blocking and synchronous/asynchronous
*"If routine A calls routine B then routine A is the caller and routine B is the callee. i.e. the caller is the routine which is calling the callee."*

### Blocking/non-blocking
Äá»‘i tÆ°á»£ng hÆ°á»›ng Ä‘áº¿n á»Ÿ Ä‘Ã¢y lÃ  `caller`.
- **Blocking:** Äiá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  sau khi gá»i má»™t hÃ m, **caller** sáº½ Ä‘á»£i giÃ¡ trá»‹ tráº£ vá» cá»§a hÃ m vÃ  luá»“ng **(thread)** á»Ÿ tráº¡ng thÃ¡i treo.
- **Non-blocking:** Äiá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  sau khi gá»i má»™t hÃ m, **caller** khÃ´ng Ä‘á»£i giÃ¡ trá»‹ tráº£ vá» cá»§a hÃ m vÃ  luá»“ng **(thread)** tiáº¿p tá»¥c cháº¡y cÃ¡c chÆ°Æ¡ng trÃ¬nh khÃ¡c (thá»±c hiá»‡n cÃ¡c thao tÃ¡c khÃ¡c hoáº·c tiáº¿p tá»¥c duyá»‡t xem hÃ m cÃ³ tráº£ vá» giÃ¡ trá»‹ hay khÃ´ng)

### Synchronous/Asynchronous
Äá»‘i tÆ°á»£ng hÆ°á»›ng Ä‘áº¿n lÃ  `callee`.

***Synchronous** execution means the first task in a program must finish processing before moving on to executing the next task whereas **asynchronous** execution means a second task can begin executing in parallel, without waiting for an earlier task to finish.*

## MÃ´ hÃ¬nh I/O
Pháº§n sau Ä‘Ã¢y láº¥y hÃ m `recvfrom/recv` lÃ m vÃ­ dá»¥. Cáº£ hai hÃ m Ä‘á»u lÃ  hÃ m kernel cá»§a há»‡ Ä‘iá»u hÃ nh vÃ  Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ nháº­n dá»¯ liá»‡u tá»« socket (Ä‘Æ°á»£c káº¿t ná»‘i) vÃ  náº¯m báº¯t Ä‘á»‹a chá»‰ cá»§a nguá»“n gá»­i dá»¯ liá»‡u.
~~~c
ssize_t recv(int sockfd, void *buff, size_t nbytes, int flags)
~~~
Vá»›i:
- `sockfd`: MÃ´ táº£ file cá»§a socket dÃ¹ng Ä‘á»ƒ nháº­n dá»¯ liá»‡u.
- `buff`: Bá»™ Ä‘á»‡m lÆ°u trá»¯ dá»¯ liá»‡u nháº­n Ä‘Æ°á»£c tá»« hÃ m recv.
- `nbytes`: Äá»™ dÃ i tá»‘i Ä‘a cá»§a bá»™ Ä‘á»‡m buff.
- `flags`: ThÆ°á»ng Ä‘áº·t lÃ  0.


Trong há»‡ thá»‘ng Linux, socket Ä‘Æ°á»£c trá»«u tÆ°á»£ng hÃ³a nhÆ° má»™t luá»“ng. Viá»‡c thá»±c hiá»‡n IO lÃ  thao tÃ¡c Ä‘á»c/ghi luá»“ng nÃ y.

Khi thá»±c hiá»‡n má»™t thao tÃ¡c recv, dá»¯ liá»‡u sáº½ Ä‘i qua hai giai Ä‘oáº¡n chÃ­nh:
- Stage 1: Chá» dá»¯ liá»‡u sáºµn sÃ ng -> Há»‡ Ä‘iá»u hÃ nh chá» gÃ³i dá»¯ liá»‡u tá»« máº¡ng, sau Ä‘Ã³ lÆ°u vÃ o bá»™ Ä‘á»‡m trong kernel.
- Stage 1: Sao chÃ©p dá»¯ liá»‡u -> Dá»¯ liá»‡u tá»« bá»™ Ä‘á»‡m kernel Ä‘Æ°á»£c sao chÃ©p sang vÃ¹ng nhá»› cá»§a á»©ng dá»¥ng.

> Hoáº¡t Ä‘á»™ng cá»§a socket stream:
>- Stage 1: Chá» gÃ³i dá»¯ liá»‡u Ä‘áº¿n tá»« máº¡ng vÃ  Ä‘Æ°á»£c lÆ°u trá»¯ trong má»™t bá»™ Ä‘á»‡m cá»§a kernel.
>- Stage 1: Sao chÃ©p dá»¯ liá»‡u tá»« bá»™ Ä‘á»‡m kernel sang bá»™ Ä‘á»‡m cá»§a á»©ng dá»¥ng (buff).
{: .prompt-info }




  
### Block IO
Äiá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  sau khi gá»i má»™t hÃ m, **caller** sáº½ Ä‘á»£i giÃ¡ trá»‹ tráº£ vá» cá»§a hÃ m vÃ  luá»“ng **(thread)** á»Ÿ tráº¡ng thÃ¡i treo. VÃ­ dá»¥: náº¿u báº¡n Ä‘áº¿n phÃ²ng thá»­ Ä‘á»“ trong trung tÃ¢m mua sáº¯m vÃ  cÃ³ ngÆ°á»i á»Ÿ bÃªn trong, báº¡n sáº½ luÃ´n Ä‘á»£i á»Ÿ ngoÃ i cá»­a. (Cháº·n hoÃ n toÃ n)
![Block IO](/assets/articles/2025/Linux_IO/2025-1-28-BlockIO.png){: .normal }

#### QuÃ¡ trÃ¬nh thá»±c hiá»‡n lá»‡nh gá»i há»‡ thá»‘ng `recv()`

**Stage 1: Chuáº©n bá»‹ dá»¯ liá»‡u**

Khi tiáº¿n trÃ¬nh ngÆ°á»i dÃ¹ng gá»i lá»‡nh há»‡ thá»‘ng `recv()`, kernel báº¯t Ä‘áº§u giai Ä‘oáº¡n Ä‘áº§u tiÃªn cá»§a IO â€“ chuáº©n bá»‹ dá»¯ liá»‡u.
- Trong máº¡ng IO, dá»¯ liá»‡u cÃ³ thá»ƒ chÆ°a sáºµn sÃ ng ngay táº¡i thá»i Ä‘iá»ƒm gá»i lá»‡nh. VÃ­ dá»¥: kernel pháº£i chá» má»™t gÃ³i UDP hoÃ n chá»‰nh Ä‘Æ°á»£c nháº­n trÆ°á»›c khi xá»­ lÃ½.
- Kernel sáº½ Ä‘á»£i dá»¯ liá»‡u Ä‘áº¿n vÃ  sao chÃ©p dá»¯ liá»‡u vÃ o bá»™ Ä‘á»‡m cá»§a mÃ¬nh. Trong thá»i gian nÃ y, tiáº¿n trÃ¬nh ngÆ°á»i dÃ¹ng bá»‹ cháº·n (náº¿u tiáº¿n trÃ¬nh lá»±a chá»n cháº¿ Ä‘á»™ cháº·n).
  
**Stage 2: Sao chÃ©p dá»¯ liá»‡u**
Sau khi dá»¯ liá»‡u sáºµn sÃ ng:Kernel sao chÃ©p dá»¯ liá»‡u tá»« bá»™ Ä‘á»‡m cá»§a kernel sang vÃ¹ng nhá»› cá»§a tiáº¿n trÃ¬nh ngÆ°á»i dÃ¹ng. Sau Ä‘Ã³, kernel tráº£ vá» káº¿t quáº£. Tiáº¿n trÃ¬nh ngÆ°á»i dÃ¹ng sáº½ Ä‘Æ°á»£c bá» tráº¡ng thÃ¡i cháº·n vÃ  tiáº¿p tá»¥c thá»±c thi.

> Äáº·c Ä‘iá»ƒm cá»§a Block IO lÃ  tiáº¿n trÃ¬nh sáº½ cháº·n á»Ÿ cáº£ hai giai Ä‘oáº¡n (chá» dá»¯ liá»‡u vÃ  sao chÃ©p dá»¯ liá»‡u).
{: .prompt-info }

#### ğŸ‘ Æ¯u Ä‘iá»ƒm
- Kháº£ nÄƒng tráº£ láº¡i dá»¯ liá»‡u ká»‹p thá»i: Dá»¯ liá»‡u Ä‘Æ°á»£c xá»­ lÃ½ ngay khi sáºµn sÃ ng, trÃ¡nh tÃ¬nh tráº¡ng cháº­m trá»….
- Giáº£m Ä‘á»™ phá»©c táº¡p cho cÃ¡c nhÃ  phÃ¡t triá»ƒn kernel: Kernel khÃ´ng cáº§n xá»­ lÃ½ logic phá»©c táº¡p liÃªn quan Ä‘áº¿n cháº¿ Ä‘á»™ khÃ´ng cháº·n.
#### ğŸ‘ NhÆ°á»£c Ä‘iá»ƒm:
- Giáº£m hiá»‡u suáº¥t: Tá»« gÃ³c Ä‘á»™ tiáº¿n trÃ¬nh ngÆ°á»i dÃ¹ng, viá»‡c bá»‹ cháº·n sáº½ lÃ m giáº£m hiá»‡u quáº£, Ä‘áº·c biá»‡t khi dá»¯ liá»‡u cáº§n thá»i gian dÃ i Ä‘á»ƒ sáºµn sÃ ng.
  
## Reference
- https://everything2.com/title/caller+vs+callee
- https://www.koyeb.com/blog/introduction-to-synchronous-and-asynchronous-processing#executing-tasks-sync-versus-async
